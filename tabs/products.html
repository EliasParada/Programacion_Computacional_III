<div class="container">
    <div class="row">
        <!-- FORMULARIO PARA LOS PRODUCTOS -->
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title" id="tblTitle">Agregar un nuevo producto</span>
                    <form id="frmProduct" data-action="create" data-id="0">
                        <div class="col s12 m4">
                            <div class="col s12 center-align" id="vidStream">
                                <video id="vidPrd" class="responsive-video"></video>
                            </div>
                            <div class="col s12 m12 center-align" id="imgVista">
                                <div class="input-field">
                                    <p class="center-align" id="txtPrdPreview"></p>
                                    <img src="../img/media/user-default.jpg" alt="" id="imgPrdPreview" class="" height="200" width="200">
                                    <canvas id="canvas" class="none" hidden data-update="false"></canvas>
                                    <canvas id="canvas2" class="none" hidden></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m8">
                            <div class="input-field col s6 m2 l2">
                                <div class="switch">
                                    <label id="lblStatus">
                                        <input type="checkbox" name="chkStatus" id="chkStatus">
                                        <span class="lever tooltipped" data-position="top" data-tooltip="Switch between the camera and a file"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="file-field input-field col s12 m4" id="imgFileContainerPrd" style="margin-bottom: 0;">
                                <div class="btn tooltipped" data-position="top" data-tooltip="Upload a file">
                                    <span>
                                        <i class="material-icons">perm_media</i>
                                    </span>
                                    <input type="file" name="imgFilePrd" id="imgFilePrd">
                                </div>
                                <div class="file-path-wrapper">
                                    <input class="file-path validate" type="text" placeholder="Seleccione una imagen">
                                </div>
                            </div>
                            <div class="col s7 m4"  id="vidControlsContainer">
                                <div class="input-field center-align">
                                    <div class="btn tooltipped" data-position="top" data-tooltip="Take a photo" id="btnTakePhoto">
                                        <span>
                                            <i class="material-icons">add_a_photo</i>
                                        </span>
                                    </div>
                                    <div class="btn tooltipped" data-position="top" data-tooltip="Take other photo" id="btnRetakePhoto">
                                        <span>
                                            <i class="material-icons">refresh</i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="">
                                    <label for="txtPrdName">Nombre</label>
                                    <input type="text" name="txtPrdName" id="txtPrdName" required placeholder="Manzana"
                                        pattern="(^[A-ZÁÉÍÓÚÑ]{1}[a-záéíóúñ]{1,20})+(([\s][A-ZÁÉÍÓÚÑ]{1}[a-záéíóúñ]{1,20})+)*$">
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="">
                                    <label for="txtPrdPrice">Precio</label>
                                    <input type="number" name="txtPrdPrice" id="txtPrdPrice" step="0.01" required placeholder="2.50"
                                        pattern="^[0-9]+(\.[0-9]{1,2})?$">
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="">
                                    <label for="txtPrdCreateDate">Fecha de fabricacion</label>
                                    <input type="tel" name="txtPrdCreateDate" id="txtPrdCreateDate" required placeholder="yyyy-mm-dd" 
                                    pattern="(^[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$)">
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="">
                                    <label for="txtPrdExpiration">Fecha de vencimiento</label>
                                    <input type="tel" name="txtPrdExpiration" id="txtPrdExpiration" required placeholder="yyyy-mm-dd" 
                                    pattern="(^[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$)">
                                </div>
                            </div>
                            <div class="col s12 m6" style="margin-bottom: 8px;">
                                <div class="input-field">
                                    <select name="slcPrdCategory" id="slcPrdCategory" required>
                                        <option value="" disabled selected>Seleccione una categoría</option>
                                    </select>
                                    <label for="slcPrdCategory">Categorias</label>
                                </div>
                            </div>
                            <div class="col s12 m6" style="margin-bottom: 8px;">
                                <div class="input-field">
                                    <select name="slcPrdProvider" id="slcPrdProvider" required>
                                        <option value="" disabled selected>Seleccione una marca</option>
                                    </select>
                                    <label for="slcPrdProvider">Proveedores</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <button class="btn waves-effect waves-light" type="submit" name="btnAction">
                                    <i class="material-icons">send</i>
                                </button>
                            </div>
                            <div class="col">
                                <button class="btn waves-effect waves-light" type="reset" name="btnReset" id="btnCatReset">
                                    <i class="material-icons">clear</i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- TABLE PARA LOS PRODUCTOS -->
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Productos</span>
                    <table class="responsive-table highlight" id="tblProducts">
                        <thead>
                            <tr>
                                <th colspan="9">
                                    <div class="input-field">
                                        <input type="text" id="txtSearch">
                                        <label for="txtSearch">Buscar</label>
                                    </div>
                                </th>
                            </tr>
                            <tr>
                                <th class="center-align">ID</th>
                                <th class="center-align">Nombre</th>
                                <th class="center-align">Proveedor</th>
                                <th class="center-align">Fecha de fabricacion</th>
                                <th class="center-align">Fecha de vencimiento</th>
                                <th class="center-align">Categoria</th>
                                <th class="center-align">Precio</th>
                                <th class="center-align">Imagen</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- ... -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function showProducts(products) {
        $('#tblProducts tbody').html('');
        products.forEach(product => {
            // La imagen debe ser pequeña
            $('#tblProducts tbody').append(`
                <tr onclick='updateProduct(${JSON.stringify(product)})'>
                    <td>${product.prt_id}</td>
                    <td>${product.prt_name}</td>
                    <td>${product.prov_name }</td>
                    <td>${product.prt_createdate}</td>
                    <td>${product.prt_expirationdate}</td>
                    <td>${product.cat_name}</td>
                    <td>${product.prt_cost}</td>
                    <td>
                        <img src="${product.prt_photo}" alt="${product.prt_name}" class="responsive-img" width="200" height="200">
                    </td>
                    <td>
                        <a href="#tblProducts" class="btn-floating btn-small waves-effect waves-light red" onclick='deleteProduct(${JSON.stringify(product)})'>
                            <i class="material-icons">delete</i>
                        </a>
                    </td>
                </tr>
            `);
        });
    }

    function showSltCategories(categories) {
        categories.forEach(category => {
            $('#slcPrdCategory').append(`
                <option value="${category.cat_id}">${category.cat_name}</option>
            `);
        });
        $('#slcPrdCategory').formSelect();
    }

    function deleteProduct(product) {
        if (confirm(`¿Esta seguro de eliminar el producto ${product.prt_name}?`)) {
            let data = {
                action: 'delete',
                id: product.prt_id
            };
            console.log(data);
            adminPetition('http://localhost:3000/admin_products', data, 'POST', 'reloadProducts');
        }
    }

    function showSltProviders(providers) {
        providers.forEach(provider => {
            $('#slcPrdProvider').append(`
                <option value="${provider.prov_id}">${provider.prov_name}</option>
            `);
        });
        $('#slcPrdProvider').formSelect();
    }

    function updateProduct(data) {
        $('#txtPrdName').val(data.prt_name);
        $('#slcPrdProvider').val(data.prov_id);
        $('#slcPrdCategory').val(data.cat_id);
        let date = data.prt_createdate.split('/');
        let jsDate = date[2] + '-' + date[1] + '-' + date[0];
        $('#txtPrdCreateDate').val(jsDate);
        date = data.prt_expirationdate.split('/');
        jsDate = date[2] + '-' + date[1] + '-' + date[0];
        $('#txtPrdExpiration').val(jsDate);
        $('#txtPrdPrice').val(data.prt_cost);
        $('#imgPrdPreview')[0].src = data.prt_photo;
        $('#frmProduct').data('action', 'update');
        $('#frmProduct').data('id', data.prt_id);
        console.log($('#frmProduct').data('action'), $('#frmProduct').data('id'));
        $('select').formSelect();
    }

    function takePhoto() {
        canvas = document.getElementById('canvas');
        let canvas2 = document.getElementById('canvas2');
        canvas2.width = video.width;
        canvas2.height = video.height;
        let ctx2 = canvas2.getContext('2d');
        ctx2.drawImage(video, 0, 0, 200, 200);
        video.pause();
        setTimeout(e => {
            video.play();
        }, 1000);
        
        canvas.width = 48;
        canvas.height = 48;
        ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas2.width = 200;
        canvas2.height = 200;
        ctx2 = canvas2.getContext('2d');
        ctx2.drawImage(video, 0, 0, canvas2.width, canvas2.height);

        let data = canvas.toDataURL('image/png');
        document.getElementById("imgPrdPreview").src = data;

        let data2 = canvas2.toDataURL('image/png');
        let img = document.getElementById("imgPrdPreview");
        img.src = data2;
    }

    function turnOnCamera() {
        canvas = document.getElementById('canvas');
        cxt = canvas.getContext('2d');
        video = document.getElementById('vidPrd');
        video.width = 200;
        video.height = 200;

        if (!navigator.getUserMedia) {
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        }
        if (!window.URL) {
            window.URL = window.URL;
        }

        if (navigator.getUserMedia) {
            navigator.getUserMedia({video: true,audio: false
            }, function (stream) {
                try {
                    localstream = stream;
                    video.srcObject = stream;
                    video.play();
                } catch (err) {
                    console.log(err);
                    video.srcObject = null;
                }
            }, function (error) {
                console.warn('¡Algo ha salido mal!', error); 
            });
        } else {
            console.error('¡Ha ocurrido un error!');
            return
        }
    }

    function turnOffCamera() {
        video.pause();
        video.srcObject = null;
        localstream.getTracks()[0].stop();
    }

    function showPredict(predict) {
        console.log(predict);
        $('#txtPrdPreview').text(predict.label);
        $('#txtPrdName').val(predict.label);
        $('#slcPrdCategory').val(predict.category);
        $('#slcPrdProvider').val(predict.provider);
        $('select').formSelect();
    }

    $(document).ready(async function(){
        let localstream, canvas, video, cxt;
        $('select').formSelect();
        $("select[required]").css({display: "block", height: 0, padding: 0, width: 0, position: 'absolute'});
        $('#vidStream').hide();
        $('#vidControlsContainer').hide();
        $('#txtPrdCreateDate').datepicker({
            format: 'yyyy-mm-dd',
            i18n: {
                months: [ 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                monthsShort: [ 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                weekdays: [ 'Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado'],
                weekdaysShort: [ 'Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                weekdaysAbbrev: [ 'D', 'L', 'M', 'M', 'J', 'V', 'S'],
                cancel: 'Cancelar',
                clear: 'Limpiar',
                done: 'Listo'
            }
        });
        $('#txtPrdExpiration').datepicker({
            format: 'yyyy-mm-dd',
            i18n: {
                months: [ 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                monthsShort: [ 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                weekdays: [ 'Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado'],
                weekdaysShort: [ 'Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                weekdaysAbbrev: [ 'D', 'L', 'M', 'M', 'J', 'V', 'S'],
                cancel: 'Cancelar',
                clear: 'Limpiar',
                done: 'Listo'
            }
        });
        window.document.title = 'Fast Store::Productos';

        adminPetition('http://localhost:3000/show_categories', {}, 'GET', 'selectCategories');
        adminPetition('http://localhost:3000/show_providers', {}, 'GET', 'selectProviders');
        adminPetition('http://localhost:3000/show_products', {}, 'GET', 'tableProducts');

        $('#imgFilePrd').change(function(){
            let file = this.files[0],
                canvas = $('#canvas')[0],
                ctx = canvas.getContext("2d"),
                canvas2 = $('#canvas2')[0],
                ctx2 = canvas2.getContext('2d');
            
            let reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e){
                $('#imgPrdPreview').attr('src', e.target.result);
                canvas.width = 48;
                canvas.height = 48;
                
                let img = new Image();
                img.src = e.target.result;
                img.onload = function(){
                    ctx.drawImage(img, 0, 0, 48, 48);
                    
                    canvas2.width = 200;
                    canvas2.height = 200;
                    ctx2.drawImage(img, 0, 0, 200, 200);
                    $('#canvas').attr('data-update', 'true');
                    let data2 = canvas2.toDataURL('image/png');
                    let imgPrd = document.getElementById("imgPrdPreview");
                    imgPrd.src = data2;

                    let pixeles = [];
                    for(i=0; i<48;i++){
                        for(j=0; j<48; j++){
                            let imgData = ctx.getImageData(j,i,1,1).data,
                                valor= (imgData[0] + imgData[1] + imgData[2])/3;
                            pixeles.push(valor);
                        }
                    }
                    let data = {
                        photo: pixeles = pixeles.join(",")
                    }

                    adminPetition('http://localhost:3000/predict', data, 'POST', 'showPredict');
                }
            }
        });

        $('#btnTakePhoto').click((e) => {
            e.preventDefault();
            takePhoto();
            turnOffCamera();

            let canvasProduct = $('#canvas')[0];
            let ctxProduct = canvasProduct.getContext('2d');
            $('#imgVista').show();
            $('#vidStream').hide();

            let pixeles = [];
            for(i=0; i<48;i++){
                for(j=0; j<48; j++){
                    let imgData = ctxProduct.getImageData(j,i,1,1).data,
                        valor= (imgData[0] + imgData[1] + imgData[2])/3;
                    pixeles.push(valor);
                }
            }
            let data = {
                photo: pixeles = pixeles.join(",")
            }

            adminPetition('http://localhost:3000/predict', data, 'POST', 'showPredict');
            console.log('Update');
            $('#canvas').attr('data-update', 'true');
        });

        $('#btnRetakePhoto').click((e) => {
            e.preventDefault();
            turnOnCamera();
            $('#vidStream').show();
            $('#imgVista').hide();
        });
        
        $("#chkStatus").change(e => {
            if ($("#chkStatus").is(":checked")) {
                turnOnCamera();
                $('#vidControlsContainer').show();
                $('#imgFileContainerPrd').hide();
                $("#imgFilePrd").attr("disabled", true);
                $('#imgVista').hide();
                $('#vidStream').show();
            } else {
                turnOffCamera();
                $('#imgFileContainerPrd').show();
                $('#vidControlsContainer').hide();
                $("#imgFilePrd").attr("disabled", false);
                $('#imgVista').show();
                $('#vidStream').hide();
            }
        });
    
        $('#frmProduct').submit( (e) => {
            e.preventDefault();
            canvas = $('#canvas2')[0];
            ctx = canvas.getContext('2d');

            canvasPreview = $('#canvas')[0];
            ctxPreview = canvasPreview.getContext('2d');
            $('.materialboxed').materialbox();

            let photo = [];
            for(i=0; i<200;i++){
                for(j=0; j<200; j++){
                    let imgData = ctx.getImageData(j,i,1,1).data,
                        rgb = imgData[0] + ',' + imgData[1] + ',' + imgData[2];
                    photo.push(rgb);
                }
            }
            photo = photo.join(',');
            let action = $('#frmProduct').data('action'),
                id = $('#frmProduct').data('id'),
                newPhoto = $('#canvas').data('update'),
                name = $('#txtPrdName').val(),
                prov = $('#slcPrdProvider').val(),
                cat = $('#slcPrdCategory').val(),
                createdate = $('#txtPrdCreateDate').val(),
                expirationdate = $('#txtPrdExpiration').val(),
                cost = $('#txtPrdPrice').val(),
                data = {action, id, name, prov, cat, createdate, expirationdate, cost, photo, newPhoto};
            console.log(data);

            console.log($('#imgPrdPreview').attr('src'));
            adminPetition('http://localhost:3000/admin_products', data, 'POST', 'reloadProducts', $('#frmProduct'));
            $('#canvas').attr('data-update', 'false');
            $('#imgPrdPreview')[0].src = '../img/media/user-default.jpg';
        })
        .on('reset', (e) => {
            clearForms($('#frmProduct'));
            $('#canvas').attr('data-update', 'false');
            $('#imgPrdPreview')[0].src = '../img/media/user-default.jpg';
        });
    
        $("#txtSearch").keyup(function(e){
            let valor = $(this).val(),
                $tblProducts = $("#tblProducts tbody tr");
            $tblProducts.show();
            let $fila = $tblProducts.filter(function(index){
                return $(this).find("td:not(:last)").text().toLowerCase().indexOf(valor.toLowerCase())==-1;
            });
            $fila.hide();
        });
    });
</script>