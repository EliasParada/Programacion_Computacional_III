<div class="container">
    <div class="row">
        <!-- FORMULARIO PARA PROVEEDORES -->
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title" id="tblTitle">Agregar una nueva factura</span>
                    <form id="frmBill" data-action="create" data-id="0">
                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <select name="cmbBillUser" id="cmbBillUser" required>
                                        <option value="" disabled selected>Seleccione al usuario</option>
                                    </select>
                                    <label for="cmbBillUser">Usuario</label>
                                </div>
                                <div class="col s12">
                                    <label for="txtDateBill">Fecha</label>
                                    <input type="tel" name="txtDateBill" id="txtDateBill" required>
                                </div>
                            </div>
                            <div class="col s12 m6" id="containerPrd" style="height: 40vh; overflow-y: auto;">
                                <!--  -->
                            </div>
                        </div>
                        <div class="row">
                            <div class="col s12 m6">
                                <span class="waves-effect waves-light btn" id="btnCalcPrice">Calcular precio</span>
                                <div class="chip" id="chipTotal">
                                    <span>Total: $<b id="lblTotalPriceBill">...</b></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <button class="btn waves-effect waves-light" type="submit" name="btnAction">
                                    <i class="material-icons">send</i>
                                </button>
                                <button class="btn waves-effect waves-light" type="reset" name="btnCatReset" id="btnCatReset">
                                    <i class="material-icons">clear</i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- TABLA PARA PROVEEDORES -->
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title">Facturas</span>
                <table class="responsive-table highlight" id="tblBills">
                    <thead>
                        <tr>
                            <th colspan="4">
                                <div class="input-field">
                                    <input type="text" id="txtSearch">
                                    <label for="txtSearch">Buscar</label>
                                </div>
                            </th>
                        </tr>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Fecha de Factura</th>
                            <th>Productos Comprados</th>
                            <th>Precio Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                        <!-- ... -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    function showBills(bills) {
        $('#tblBills tbody').html('');
        bills.forEach(bill => {
            let products = bill.prd_name.split(',');
            let cant = bill.prd_cant.split(',');
            let price = bill.subprice.split(',');
            let productsHTML = '';
            for (let i = 0; i < products.length; i++) {
                productsHTML += `<li class="chip" style="display: block; width: max-content; padding-right: 0;">${products[i]} <span class="chip" style="background-color: rgb(240, 240, 240);">${cant[i]}</span><span class="chip" style="background-color: rgb(240, 240, 240); margin-right: 0;">$${price[i]}</span></li>`;
            }
            $('#tblBills tbody').append(`
                <tr>
                    <td>${bill.fac_id}</td>
                    <td>${bill.ux_name}</td>
                    <td>${bill.fac_date}</td>
                    <td>
                        ${productsHTML}
                    </td>
                    <td>${bill.fac_price}</td>
                    <td>
                        <span class="btn-floating btn-small waves-effect waves-light red" onclick='deleteBill(${JSON.stringify(bill)})'><i class="material-icons">delete</i></span>
                    </td>
                </tr>
            `);
        });
    }

    function updateBill(bill) {
        $('#txtBillName').val(bill.prov_name);
        $('#txtBillPhone').val(bill.prov_phone);
        $('#txtBillEmail').val(bill.prov_mail);
        $('#frmBill').attr('data-action', 'update');
        $('#frmBill').attr('data-id', bill.prov_id);    
    }

    function deleteBill(bill) {
        if (confirm(`Â¿Esta seguro de eliminar la factura ${bill.fac_id}?`)) {
            let data = {
                action: 'delete',
                id: bill.fac_id,
                user: 'None'
            };
            console.log(data);
            adminPetition('http://localhost:3000/bill', data, 'POST', 'reloadBills');
        }
    }

    function showSltUsers(users) {
        console.log(users);
        $('#cmbBillUser').html('');
        users.forEach(user => {
            $('#cmbBillUser').append(`
                <option value="${user.ux_id}">${user.ux_dui} | ${user.ux_name}</option>
            `);
        });
        $('#cmbBillUser').formSelect();
    }

    function updatePrice(cant) {
        console.log(cant);
        let currentCant = cant.value;
        let lastCant = cant.dataset.lastCant;
        if (currentCant > lastCant) {
            let price = cant.dataset.price;
            let totalPrice = (currentCant - lastCant) * price;
            $('#lblTotalPriceBill').html(parseFloat($('#lblTotalPriceBill').html()) + totalPrice);
        } else if (currentCant < lastCant) {
            let price = cant.dataset.price;
            let totalPrice = (lastCant - currentCant) * price;
            $('#lblTotalPriceBill').html(parseFloat($('#lblTotalPriceBill').html()) - totalPrice);
        }
        cant.dataset.lastCant = currentCant;
    }

    function showSltProducts(products) {
        let productshtml = '';
        console.log(products);
        products.forEach(prod => {
            productshtml += `
            <div class="row">
                <div class="col s12 m6">
                    <label for="chkPrd${prod.prt_id}">
                        <input type="checkbox" id="chkPrd${prod.prt_id}" name="chkPrd" value="${prod.prt_id}" class="left" />
                        <span>${prod.prt_name} $${prod.prt_cost}</span>
                    </label>
                </div>
                <div class="col s12 m6">
                    <input type="number" id="txtCantPrd${prod.prt_id}" name="txtCantPrd${prod.prt_id}" data-price="${prod.prt_cost}" style="height: 1.5rem;" placeholder="Cantidad" hidden />
                </div>
            </div>
            `;
        });
        $('#containerPrd').append(productshtml);
    }

    $(document).ready(function(){
        $('select').formSelect();
        $("select[required]").css({display: "block", height: 0, padding: 0, width: 0, position: 'absolute'});
        $('#txtDateBill').datepicker({
            format: 'yyyy-mm-dd',
            i18n: {
                months: [ 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                monthsShort: [ 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                weekdays: [ 'Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado'],
                weekdaysShort: [ 'Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                weekdaysAbbrev: [ 'D', 'L', 'M', 'M', 'J', 'V', 'S'],
                cancel: 'Cancelar',
                clear: 'Limpiar',
                done: 'Listo'
            }
        });
        window.document.title = 'Fast Store::Facturas';

        adminPetition('http://localhost:3000/show_products', {}, 'GET', 'selectProducts');
        adminPetition('http://localhost:3000/show_users', {}, 'GET', 'selectUsers');
        adminPetition('http://localhost:3000/show_bills', {}, 'GET', 'tableBills');

        $('#btnCalcPrice').click(function(){
            let totalPrice = 0;
            $('input[name="chkPrd"]:checked').each(function(){
                let cant = $('#txtCantPrd' + $(this).val());
                totalPrice += cant.val() * cant.data('price');
            });
            $('#lblTotalPriceBill').html(totalPrice);
        });

        $('#frmBill').submit( (e) => {
            e.preventDefault();
            let products = [];
            $('input[name="chkPrd"]:checked').each(function() {
                let id = $(this).val();
                let cant = $('#txtCantPrd' + id).val();
                products.push({
                    id: id,
                    cant: cant,
                    subprice: cant * $(`#txtCantPrd${id}`).data('price')
                });
            });
            let total = 0;
            products.forEach(product => {
                total += parseFloat(product.cant) * $(`#txtCantPrd${product.id}`).data('price');
            });
            $('#lblTotalPriceBill').html(total);
            console.log(products);
            let action = $('#frmBill').data('action'),
                id = $('#frmBill').data('id'),
                date = $('#txtDateBill').val(),
                user = $('#cmbBillUser').val(),
                data = {action, id, user, products, date, total};
            console.log(data);
            adminPetition('http://localhost:3000/bill', data, 'POST', 'reloadBills', $('#frmBill'));
        })
        .on('change', 'input[name="chkPrd"]', function() {
            let id = $(this).val();
            let total = 0;
            if ($(this).is(':checked')) {
                $('#txtCantPrd' + id).show();
                $(`#txtCantPrd${id}`).attr('required', true);
                total += parseFloat($(`#txtCantPrd${id}`).val()) * $(`#txtCantPrd${id}`).data('price');
            } else {
                $('#txtCantPrd' + id).hide();
                $(`#txtCantPrd${id}`).attr('required', false);
                $(`#txtCantPrd${id}`).val('');
            }
            $('#lblTotalPriceBill').html(total);
        })
        .on('reset', (e) => {
            clearForms($('#frmBill'));
        });
    
        $("#txtSearch").keyup(function(e){
            let valor = $(this).val(),
                $tblProducts = $("#tblBills tbody tr");
            $tblProducts.show();
            let $fila = $tblProducts.filter(function(index){
                return $(this).find("td:not(:last)").text().toLowerCase().indexOf(valor.toLowerCase())==-1;
            });
            $fila.hide();
        });
    });
</script>