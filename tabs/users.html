<div class="container">
    <div class="row">
        <!-- FORMULARIO PARA USUARIOS -->
        <div class="col s12 m12 l12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title" id="tblTitle">Agregar un nuevo usuario</span>
                    <form id="frmUsers" data-action="create" data-id="0">
                        <div class="col s12 m4">
                            <div class="col s12 center-align" id="vidStream">
                                <video id="vidUser" class="responsive-video"></video>
                            </div>
                            <div class="col s12 m12 center-align" id="imgVista">
                                <div class="input-field">
                                    <p class="center-align" id="txtUserPreview"></p>
                                    <img src="../img/media/profile.png" alt="" id="imgUserPreview" class="responsive materialboxed" width="200" height="200">
                                    <canvas id="canvas" class="none" hidden data-update="false"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m8">
                            <div class="input-field col s6 m4 l2">
                                <div class="switch">
                                    <label id="lblStatus">
                                        <input type="checkbox" name="chkStatusUser" id="chkStatusUser">
                                        <span class="lever tooltipped" data-position="top" data-tooltip="Switch between the camera and a file"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="file-field input-field col s7 m4" id="imgFileContainerUser">
                                <div class="btn tooltipped" data-position="top" data-tooltip="Upload a file">
                                    <span>
                                        <i class="material-icons">perm_media</i>
                                    </span>
                                    <input type="file" name="imgFileUser" id="imgFileUser">
                                </div>
                                <div class="file-path-wrapper">
                                    <input class="file-path validate" type="text" placeholder="Seleccione una imagen">
                                </div>
                            </div>
                            <div class="col s7 m4"  id="vidUserContainer">
                                <div class="input-field center-align">
                                    <div class="btn tooltipped" data-position="top" data-tooltip="Take a photo" id="btnTakePhotoUser">
                                        <span>
                                            <i class="material-icons">add_a_photo</i>
                                        </span>
                                    </div>
                                    <div class="btn tooltipped" data-position="top" data-tooltip="Take other photo" id="btnRetakePhotoUser">
                                        <span>
                                            <i class="material-icons">refresh</i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <input type="text" name="txtDuiUser" id="txtDuiUser" required>
                                    <label for="txtDuiUser">DUI</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <input type="text" name="txtNameUser" id="txtNameUser" required>
                                    <label for="txtNameUser">Nombre</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <input type="text" name="txtNickUser" id="txtNickUser" required>
                                    <label for="txtNickUser">Nickname</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <input type="tel" name="txtPhoneUser" id="txtPhoneUser" required>
                                    <label for="txtPhoneUser">Telefono</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <input type="email" name="txtEmailUser" id="txtEmailUser" required>
                                    <label for="txtEmailUser">Correo</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <input type="password" name="txtPassUser" id="txtPassUser" required>
                                    <label for="txtPassUser">Contraseña</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <input type="password" name="txtRepassUser" id="txtRepassUser" required>
                                    <label for="txtRepassUser">Repetir contraseña</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <input type="tel" name="txtBirthUser" id="txtBirthUser" required>
                                    <label for="txtBirthUser">Fecha de nacimiento</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <select name="slcFeatures" id="slcFeatures" required>
                                        <option value="" selected>Seleccione los permisos</option>
                                    </select>
                                    <label for="slcFeatures">Permisos</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <button class="btn waves-effect waves-light" type="submit" name="btnAction">
                                    <i class="material-icons">send</i>
                                </button>
                            </div>
                            <div class="col">
                                <button class="btn waves-effect waves-light" type="reset" name="btnReset" id="btnCatReset">
                                    <i class="material-icons">clear</i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- TABLA PARA USUARIOS -->
    <div class="col s12">
        <div class="card">
            <div class="card-content w-11/12"  style="overflow: hidden; overflow-x: scroll;">
                <span class="card-title">Usuarios</span>
                <div class="col s12 m8 l9">
                    <div class="input-field col s12">
                        <i class="material-icons prefix">search</i>
                        <input type="text" name="txtSearch" id="txtSearch">
                        <label for="txtSearch">Buscar</label>
                    </div>
                </div>
                <table class="responsive-table highlight" id="tblUsers">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Foto</th>
                            <th>DUI</th>
                            <th>Nombre</th>
                            <th>Nickname</th>
                            <th>Teléfono</th>
                            <th>Correo</th>
                            <th>Contraseña</th>
                            <th>Fecha de Nacimiento</th>
                            <th>Permisos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ... -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    function showUsers(users) {
        $('#tblUsers tbody').html('');
        users.forEach(user => {
            $('#tblUsers tbody').append(`
                <tr onclick='updateUser(${JSON.stringify(user)})'>
                    <td>${user.ux_id}</td>
                    <td>
                        <img src="${user.ux_urlphoto}" alt="${user.ux_nick}" class="materialboxed" width="100">
                    </td>
                    <td>${user.ux_dui}</td>
                    <td>${user.ux_name }</td>
                    <td>${user.ux_nick}</td>
                    <td>${user.ux_phone}</td>
                    <td>${user.ux_mail}</td>
                    <td id="ux_pass${user.ux_id}">
                        <div class="hide-pass">${user.ux_pass.replace(/./g, '*')}</div>
                        <div class="progress">
                            <div class="determinate" style="width: 0%; transition: all 6s;"></div>
                        </div>
                    </td>
                    <td>${user.ux_DBirth}</td>
                    <td>
                        <div class="chip" style="height: fit-content;">
                            ${user.pms_type}
                        </div>
                    <td style="display: flex;" class="">
                        <div class="btn btn-floating btn-small waves-effect waves-light blue">
                            <span onclick="showPass('${user.ux_pass}', ux_pass${user.ux_id})">
                                <i class="material-icons">visibility</i>
                            </span>
                        </div>
                        <div class="btn btn-floating btn-small waves-effect waves-light red" onclick='deleteUser(${JSON.stringify(user)})'>
                            <span>
                                <i class="material-icons">delete</i>
                            </span>
                        </div>
                    </td>
                </tr>
            `);
            $('.materialboxed').materialbox();
        });
    }

    function showPass(pass, id) {
        $(id).find('.hide-pass').text(pass);
        $(id).find('.determinate').css('width', '100%').css('transition', 'all 6s'); 
        setTimeout(() => {
            $(id).find('.hide-pass').text($(id).find('.hide-pass').text().replace(/./g, '*'));
            $(id).find('.determinate').css('width', '0%').css('transition', 'all .5s');
        }, 6000);
    }

    function openImg(element) {
        console.log(element);
        let instnace = M.Materialbox.getInstance(element);
        instnace.open();
    }

    function showSltFeatures(features) {
        features.forEach(feature => {
            $('#slcFeatures').append(`
                <option value="${feature.pms_id}">${feature.pms_type}</option>
            `);
        });
        $('#slcFeatures').formSelect();
    }

    function deleteUser(user) {
        if (confirm(`¿Esta seguro de eliminar al usuario ${user.ux_name}?`)) {
            let data = {
                action: 'delete',
                id: user.ux_id
            };
            console.log(data);
            adminPetition('http://localhost:3000/admin_users', data, 'POST', 'reloadUsers');
        }
    }

    function updateUser(user) {
        $('#txtDuiUser').val(user.ux_dui);
        $('#txtNameUser').val(user.ux_name);
        $('#txtNickUser').val(user.ux_nick);
        $('#txtPhoneUser').val(user.ux_phone);
        $('#txtEmailUser').val(user.ux_mail);
        $('#txtPassUser').val(user.ux_pass);
        $('#txtRepassUser').val(user.ux_pass);
        let date = user.ux_DBirth.split('/');
        $('#txtBirthUser').val(`${date[2]}-${date[1]}-${date[0]}`);
        $('#slcFeatures').val(user.pms_ux);
        $('#slcFeatures').formSelect();
        $('#imgUserPreview').attr('src', user.ux_urlphoto);
        $('#canvas').data('update', false);
        $('#frmUsers')
            .data('id', user.ux_id)
            .data('action', 'update');
    }

    function takePhoto() {
        let canvasPrev = document.getElementById('canvas'),
            ctxPrev = canvasPrev.getContext('2d');

        canvasPrev.width = 600;
        canvasPrev.height = 600;
        ctxPrev.drawImage(video, 0, 0, 600, 600);
        video.pause();
        setTimeout(e => {
            video.play();
        }, 1000);

        let dataPrev = canvasPrev.toDataURL('image/png');
        let img = document.getElementById("imgUserPreview");
        img.src = dataPrev;
        $('#canvas').data('update', true);
    }

    function turnOnCamera() {
        canvas = document.getElementById('canvas');
        cxt = canvas.getContext('2d');
        video = document.getElementById('vidUser');
        video.width = 200;
        video.height = 200;

        if (!navigator.getUserMedia) {
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        }
        if (!window.URL) {
            window.URL = window.URL;
        }
        
        if (navigator.getUserMedia) {
            navigator.getUserMedia({video: true,audio: false
            }, function (stream) {
                try {
                    localstream = stream;
                    video.srcObject = stream;
                    video.play();
                } catch (err) {
                    console.log(err);
                    video.srcObject = null;
                }
            }, function (error) {
                console.warn('¡Algo ha salido mal!', error); 
            });
        } else {
            console.error('¡Ha ocurrido un error!');
        }
    }

    function turnOffCamera() {
        video.pause();
        video.srcObject = null;
        localstream.getTracks()[0].stop();
    }

    $(document).ready(function(){
        let localstream, canvas, video, cxt;
        $('.tooltipped').tooltip();
        $('select').formSelect();
        $("select[required]").css({display: "block", height: 0, padding: 0, width: 0, position: 'absolute'});
        $('#vidStream').hide();
        $('.materialboxed').materialbox();
        $('#vidUserContainer').hide();
        $('#txtBirthUser').datepicker({
            format: 'yyyy-mm-dd',
            i18n: {
                months: [ 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                monthsShort: [ 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                weekdays: [ 'Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado'],
                weekdaysShort: [ 'Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                weekdaysAbbrev: [ 'D', 'L', 'M', 'M', 'J', 'V', 'S'],
                cancel: 'Cancelar',
                clear: 'Limpiar',
                done: 'Listo',
            }
        });
        window.document.title = 'Fast Store::Usuarios';


        adminPetition('http://localhost:3000/show_features', {}, 'GET', 'selectFeatures');
        adminPetition('http://localhost:3000/show_users', {}, 'GET', 'tableUsers');

        $('#imgFileUser').change(function(){
            let file = this.files[0];
            
            let reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e){
                $('#imgUserPreview').attr('src', e.target.result);
                canvas = document.getElementById('canvas');
                cxt = canvas.getContext("2d");
                canvas.width = 600;
                canvas.height = 600;
                
                let img = new Image();
                img.src = e.target.result;
                img.onload = function(){
                    cxt.drawImage(img, 0, 0, 600, 600);
                    let data = canvas.toDataURL('image/png');
                    $('#imgUserPreview').attr('src', data);
                    $('#canvas').data('update', true);
                }
            }
        });

        $('btnRetakePhotoUser').click((e) => {
            console.log('click');
        });

        $('#btnTakePhotoUser').click((e) => {
            e.preventDefault();
            takePhoto();

            let canvasProduct = $('#canvas')[0];
            let ctxProduct = canvasProduct.getContext('2d');
            $('#imgVista').show();
            $('#vidStream').hide();
            $('#canvas').data('update', true);
        });
        
        $("#chkStatusUser").change(e => {
            if ($("#chkStatusUser").is(":checked")) {
                turnOnCamera();
                $('#vidUserContainer').show();
                $('#imgFileContainerUser').hide();
                $("#imgFileUser").attr("disabled", true);
                $('#imgVista').hide();
                $('#vidStream').show();
            } else {
                turnOffCamera();
                $('#imgFileContainerUser').show();
                $('#vidUserContainer').hide();
                $("#imgFileUser").attr("disabled", false);
                $('#imgVista').show();
                $('#vidStream').hide();
            }
        });
    
        $('#frmUsers').submit( (e) => {
            e.preventDefault();
            canvasPreview = $('#canvas')[0];
            ctxPreview = canvasPreview.getContext('2d');

            let photo = [];
            for(i=0; i<600;i++){
                for(j=0; j<600; j++){
                    let imgData = ctxPreview.getImageData(j,i,1,1).data,
                        rgb = imgData[0] + ',' + imgData[1] + ',' + imgData[2];
                    photo.push(rgb);
                }
            }
            photo = photo.join(',');

            let action = $('#frmUsers').data('action'),
                id = $('#frmUsers').data('id'),
                newPhoto = $('#canvas').data('update'),
                dui = $('#txtDuiUser').val(),
                name = $('#txtNameUser').val(),
                nick = $('#txtNickUser').val(),
                phone = $('#txtPhoneUser').val(),
                mail = $('#txtEmailUser').val(),
                pass = $('#txtPassUser').val(),
                dbirth = $('#txtBirthUser').val(),
                permiss = $('#slcFeatures').val(),
                data = {action, id, dui, name, nick, phone, mail, pass, dbirth, photo, permiss, newPhoto};
            console.log(data);

            adminPetition('http://localhost:3000/admin_users', data, 'POST', 'reloadUsers', $('#frmUsers'));
            $('#canvas').data('update', false);
            $('#imgUserPreview')[0].src = '../img/media/profile.png';
        })
        .on('reset', (e) => {
            clearForms($('#frmUsers'));
            $('#canvas').data('update', false);
            $('#imgUserPreview')[0].src = '../img/media/profile.png';
        });
    
        $("#txtSearch").keyup(function(e){
            let valor = $(this).val(),
                $tblUsers = $("#tblUsers tbody tr");
            $tblUsers.show();
            let $fila = $tblUsers.filter(function(index){
                return $(this).find("td:not(:last)").text().toLowerCase().indexOf(valor.toLowerCase())==-1;
            });
            $fila.hide();

            lastId = $("#tblUsers tbody tr:visible td")[0].innerHTML;
        });
    });
</script>